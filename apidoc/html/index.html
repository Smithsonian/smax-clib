<!-- HTML header for doxygen 1.9.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta charset="utf-8"/>
<meta name="description" content="C/C++ client library for SMA-X structured data exchange"/>
<meta name="keywords" content="SMA-X client library, structured data, data exchange, C, C++, C99, software library, open source, Redis client"/>
<meta name="author" content="Attila Kovacs"/>
<meta name="copyright" content="(C)2024 Attila Kovacs" />
<meta name="robots" content="index,follow"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EMRD1TX0PD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-EMRD1TX0PD');
</script>
<link rel="shortcut icon" type="image/x-icon" href="/redisx/resources/favicon.ico" />
<link rel="icon" type="image/png" sizes="192x192" href="/redisx/resources/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="/redisx/resources/android-chrome-512x512.png" />
<link rel="apple-touch-icon" type="image/png" href="/redisx/resources/apple-touch-icon.png" />
<title>smax-clib: smax-clib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="smithsonian-logo-55x55.png"/></td>
  <td id="projectalign">
   <div id="projectname">smax-clib<span id="projectnumber">&#160;v0.9</span>
   </div>
   <div id="projectbrief">A C/C++ client library for SMA-X</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">smax-clib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README-smax"></a> C/C++ client library and toolkit for the <a href="https://docs.google.com/document/d/1eYbWDClKkV7JnJxv4MxuNBNV47dFXuUWu7C4Ve_YTf0/edit?usp=sharing">SMA Exchange (SMA-X)</a> structured real-time database</p>
<ul>
<li><a href="https://smithsonian.github.io/smax-clib/apidoc/html/files.html">API documentation</a></li>
<li><a href="https://smithsonian.github.io/smax-clib">Project pages</a> on github.io</li>
</ul>
<p>Author: Attila Kovacs</p>
<p>Last Updated: 18 September 2024</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Table of Contents</h2>
<ul>
<li><a class="el" href="index.html#introduction">Introduction</a></li>
<li><a class="el" href="index.html#prerequisites">Prerequisites</a></li>
<li><a class="el" href="index.html#building">Building the SMA-X C library</a></li>
<li><a class="el" href="index.html#command-line-tools">Command-line tools</a></li>
<li><a class="el" href="index.html#configuration">Initial configuration</a></li>
<li><a class="el" href="index.html#connecting">Connecting to / disconnecting from SMA-X</a></li>
<li><a class="el" href="index.html#sharing-and-pulling">Sharing and pulling data</a></li>
<li><a class="el" href="index.html#lazy-pulling">Lazy pulling (high-frequency queries)</a></li>
<li><a class="el" href="index.html#pipelined-pulls">Pipelined pulls (high volume queries)</a></li>
<li><a class="el" href="index.html#notifications">Custom notification and update handling</a></li>
<li><a class="el" href="index.html#status-messages">Program status / error messages via SMA-X</a></li>
<li><a class="el" href="index.html#optional-metadata">Optional metadata</a></li>
<li><a class="el" href="index.html#error-handling">Error handling</a></li>
<li><a class="el" href="index.html#debug-support">Debug support</a></li>
<li><a class="el" href="index.html#future-plans">Future plans</a></li>
</ul>
<hr  />
<p><a class="anchor" id="introduction"></a> </p>
<h2><a class="anchor" id="autotoc_md5"></a>
Introduction</h2>
<p>The <a href="https://docs.google.com/document/d/1eYbWDClKkV7JnJxv4MxuNBNV47dFXuUWu7C4Ve_YTf0/edit?usp=sharing">SMA Exchange (SMA-X)</a> is a high performance and versatile real-time data sharing platform for distributed software systems. It is built around a central <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> database, and provides atomic access to structured data, including specific branches and/or leaf nodes, with associated metadadata. SMA-X was developed at the Submillimeter Array (SMA) observatory, where we use it to share real-time data among hundreds of computers and nearly a thousand individual programs.</p>
<p>SMA-X consists of a set of server-side <a href="https://lua.org/">LUA</a> scripts that run on <a href="https://redis.io">Redis</a> (or one of its forks / clones such as <a href="https://valkey.io">Valkey</a> or <a href="https://dragonfly.io">Dragonfly</a>); a set of libraries to interface client applications; and a set of command-line tools built with them. Currently we provide client libraries for C/C++ (C99) and Python 3. We may provide Java and/or Rust client libraries too in the future.</p>
<p>There are no official releases of <b>smax-clib</b> yet. An initial 1.0.0 release is expected early/mid 2025. Before then the API may undergo slight changes and tweaks. Use the repository as is at your own risk for now.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Related links</h3>
<ul>
<li><a href="https://docs.google.com/document/d/1eYbWDClKkV7JnJxv4MxuNBNV47dFXuUWu7C4Ve_YTf0/edit?usp=sharing">SMA-X specification</a></li>
<li><a href="https://github.com/Smithsonian/smax-python">Smithsonian/smax-python</a> an alternative library for Python 3.</li>
<li><a href="https://github.com/Smithsonian/smax-postgres">Smithsonian/smax-postgres</a> for creating a time-series history of SMA-X in a <b>PostgreSQL</b> database.</li>
</ul>
<hr  />
<p><a class="anchor" id="prerequisites"></a> </p>
<h2><a class="anchor" id="autotoc_md8"></a>
Prerequisites</h2>
<p>The SMA-X C/C++ library has a build and runtime dependency on the <b>xchange</b> and <b>RedisX</b> libraries also available at the Smithsonian Github repositories:</p>
<ul>
<li><a href="https://github.com/Smithsonian/xchange">Smithsonian/xchange</a></li>
<li><a href="https://github.com/Smithsonian/redisx">Smithsonian/redisx</a></li>
</ul>
<p>Additionally, to configure your <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> (or Valkey / Dragonfly) servers for SMA-X, you will need the <a href="https://github.com/Smithsonian/smax-server">Smithsonian/smax-server</a> repo also.</p>
<hr  />
<p><a class="anchor" id="building"></a> </p>
<h2><a class="anchor" id="autotoc_md10"></a>
Building the SMA-X C library</h2>
<p>The <b>smax-clib</b> library can be built either as a shared (<code>libsmax.so[.1]</code>) and as a static (<code>libsmax.a</code>) library, depending on what suits your needs best.</p>
<p>You can configure the build, either by editing <code>config.mk</code> or else by defining the relevant environment variables prior to invoking <code>make</code>. The following build variables can be configured:</p>
<ul>
<li><code>XCHANGE</code>: the root of the location where the <a href="https://github.com/Smithsonian/xchange">Smithsonian/xchange</a> library is installed. It expects to find <code><a class="elRef" href="../../xchange/apidoc/html/xchange_8h.html">xchange.h</a></code> under <code>$(XCHANGE)/include</code> and <code>libxchange.so</code> under <code>$(XCHANGE)/lib</code> or else in the default <code>LD_LIBRARY_PATH</code>.</li>
<li><code>REDISX</code>: the root of the location where the <a href="https://github.com/Smithsonian/redisx">Smithsonian/redisx</a> library is installed. It expects to find <code><a class="elRef" href="../../redisx/apidoc/html/redisx_8h.html">redisx.h</a></code> under <code>$(REDISX)/include</code> and <code>libredisx.so</code> under <code>$(REDISX)/lib</code> or else in the default <code>LD_LIBRARY_PATH</code>.</li>
<li><code>CC</code>: The C compiler to use (default: <code>gcc</code>).</li>
<li><code>CPPFLAGS</code>: C pre-processor flags, such as externally defined compiler constants.</li>
<li><code>CFLAGS</code>: Flags to pass onto the C compiler (default: <code>-Os -Wall -std=c99</code>). Note, <code>-Iinclude</code> will be added automatically.</li>
<li><code>LDFLAGS</code>: Extra linker flags (default: <em>not set</em>). Note, <code>-lm -lredisx -lxchange -pthread</code> will be added automatically.</li>
<li><code>BUILD_MODE</code>: You can set it to <code>debug</code> to enable debugging features: it will initialize the global <code>xDebug</code> variable to <code>TRUE</code> and add <code>-g</code> to <code>CFLAGS</code>.</li>
<li><code>CHECKEXTRA</code>: Extra options to pass to <code>cppcheck</code> for the <code>make check</code> target</li>
</ul>
<p>After configuring, you can simply run <code>make</code>, which will build the <code>shared</code> (<code>lib/libsmax.so[.1]</code>) and <code>static</code> (<code>lib/libsmax.a</code>) libraries, local HTML documentation (provided <code>doxygen</code> is available), and performs static analysis via the <code>check</code> target. Or, you may build just the components you are interested in, by specifying the desired <code>make</code> target(s). (You can use <code>make help</code> to get a summary of the available <code>make</code> targets).</p>
<hr  />
<p><a class="anchor" id="command-line-tools"></a> </p>
<h2><a class="anchor" id="autotoc_md12"></a>
Command-line tools</h2>
<p>The <b>smax-clib</b> library provides two basic command-line tools:</p>
<ul>
<li><code>smaxValue</code> &ndash; for exploring the contents of SMA-X, including associated metadata, and</li>
<li><code>smaxWrite</code> &ndash; for putting data into SMA-X from the shell.</li>
</ul>
<p>The tools can be compiled with <code>make tools</code>. Both tools can be run with the <code>--help</code> option for a simple help screen on usage. E.g.:</p>
<div class="fragment"><div class="line">$ smaxValue --help</div>
</div><!-- fragment --><p>These command-line tools provide a simple means to interact with SMA-X from the shell or a scripting language, such as <code>bash</code>, or <code>perl</code> (also <code>python</code> though we recommend to use the native <a href="https://github.com/Smithsonian/smax-python">Smithsonian/smax-python</a> library instead).</p>
<hr  />
<p><a class="anchor" id="configuration"></a> </p>
<h2><a class="anchor" id="autotoc_md14"></a>
Initial configuration</h2>
<p>Bu default, the library assumes that the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server used for SMA-X runs on a machine called <code>smax</code> (e.g. you may assign <code>smax</code> to the IP address in <code>/etc/hosts</code>), and that the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> is on the default port 6379/tcp. However, you can configure to use a specific host and/or an alternative <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> port number to use instead.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="smax_8c.html#a78cf94f007034f63b609cbe72b8047b0">smaxSetServer</a>(<span class="stringliteral">&quot;my-smax.example.com&quot;</span>, 7033);</div>
<div class="ttc" id="asmax_8c_html_a78cf94f007034f63b609cbe72b8047b0"><div class="ttname"><a href="smax_8c.html#a78cf94f007034f63b609cbe72b8047b0">smaxSetServer</a></div><div class="ttdeci">int smaxSetServer(const char *host, int port)</div><div class="ttdef"><b>Definition</b> smax.c:112</div></div>
</div><!-- fragment --><p>Also, while SMA-X will normally run on database index 0, you can also specify a different database number to use. E.g.:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="smax_8c.html#a79fba7411b5afa132457a6828ff5ed9f">smaxSetDB</a>(3);</div>
<div class="ttc" id="asmax_8c_html_a79fba7411b5afa132457a6828ff5ed9f"><div class="ttname"><a href="smax_8c.html#a79fba7411b5afa132457a6828ff5ed9f">smaxSetDB</a></div><div class="ttdeci">int smaxSetDB(int idx)</div><div class="ttdef"><b>Definition</b> smax.c:168</div></div>
</div><!-- fragment --><p>(Note, you can switch the database later also, but beware that if you have an active subscription client open, you cannot switch that client until the subscriptions are terminated.)</p>
<p>You can also set up the authentication credentials for using the SMA-X database on the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server:</p>
<div class="fragment"><div class="line">smaxSetUser(<span class="stringliteral">&quot;johndoe&quot;</span>);</div>
<div class="line">smaxSetPassword(mySecretPassword);</div>
</div><!-- fragment --><p>And finally, you can select the option to automatically try reconnect to the SMA-X server in case of lost connection or network errors (and keep track of changes locally until then):</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="smax-resilient_8c.html#a469095a9a74a8ce5d6bbae347d7194e5">smaxSetResilient</a>(TRUE);</div>
<div class="ttc" id="asmax-resilient_8c_html_a469095a9a74a8ce5d6bbae347d7194e5"><div class="ttname"><a href="smax-resilient_8c.html#a469095a9a74a8ce5d6bbae347d7194e5">smaxSetResilient</a></div><div class="ttdeci">void smaxSetResilient(boolean value)</div><div class="ttdef"><b>Definition</b> smax-resilient.c:62</div></div>
</div><!-- fragment --><hr  />
<p><a class="anchor" id="connecting"></a> </p>
<h2><a class="anchor" id="autotoc_md16"></a>
Connecting to / disconnecting from SMA-X</h2>
<p>Once you have configured the connection parameters, you can connec to the server by:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#a146fb2ed8512919dc91ecad6d08c74d1">smaxConnect</a>();</div>
<div class="line"><span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">   <span class="comment">// Oops, we could not connect to the server</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_a146fb2ed8512919dc91ecad6d08c74d1"><div class="ttname"><a href="smax_8c.html#a146fb2ed8512919dc91ecad6d08c74d1">smaxConnect</a></div><div class="ttdeci">int smaxConnect()</div><div class="ttdef"><b>Definition</b> smax.c:421</div></div>
</div><!-- fragment --><p>And, when you are done, you should disconnect with:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="smax_8c.html#a9d1e6ffa837d3582a8165e326cc44bea">smaxDisconnect</a>();</div>
<div class="ttc" id="asmax_8c_html_a9d1e6ffa837d3582a8165e326cc44bea"><div class="ttname"><a href="smax_8c.html#a9d1e6ffa837d3582a8165e326cc44bea">smaxDisconnect</a></div><div class="ttdeci">int smaxDisconnect()</div><div class="ttdef"><b>Definition</b> smax.c:506</div></div>
</div><!-- fragment --><p><a class="anchor" id="connection-hooks"></a> </p>
<h3><a class="anchor" id="autotoc_md17"></a>
Connection / disconnection hooks</h3>
<p>The user of the <b>smax-clib</b> library might want to know when connections to the SMA-X server are established, or when disconnections happen, and may want to perform some configuration or clean-up accordingly. For this reason, the library provides support for connection 'hooks' &ndash; that is custom functions that are called in the even of connecting to or disconnecting from a <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server.</p>
<p>Here is an example of a connection hook, which simply prints a message about the connection to the console.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> my_connect_hook() {</div>
<div class="line">   printf(<span class="stringliteral">&quot;Connected to SMA-X server\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>And, it can be activated prior to the <code><a class="el" href="smax_8c.html#a146fb2ed8512919dc91ecad6d08c74d1">smaxConnect()</a></code> call.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="smax_8c.html#ad63c425cc3affdf8bc803c7ff8dd6e30">smaxAddConnectHook</a>(my_connect_hook);</div>
<div class="ttc" id="asmax_8c_html_ad63c425cc3affdf8bc803c7ff8dd6e30"><div class="ttname"><a href="smax_8c.html#ad63c425cc3affdf8bc803c7ff8dd6e30">smaxAddConnectHook</a></div><div class="ttdeci">int smaxAddConnectHook(void(*setupCall)(void))</div><div class="ttdef"><b>Definition</b> smax.c:556</div></div>
</div><!-- fragment --><p>The same goes for disconnect hooks, using <code><a class="el" href="smax_8c.html#a65ae161b28cfe4369709fae1d3ea678c">smaxAddDisconnectHook()</a></code> instead.</p>
<hr  />
<p><a class="anchor" id="sharing-and-pulling"></a> </p>
<h2><a class="anchor" id="autotoc_md19"></a>
Sharing and pulling data</h2>
<ul>
<li><a class="el" href="index.html#basics">The basics</a></li>
<li><a class="el" href="index.html#metadata">Standard metadata</a></li>
<li><a class="el" href="index.html#flexible-types-and-sizes">Flexible types and sizes</a></li>
<li><a class="el" href="index.html#scalars">Scalar quantities</a></li>
<li><a class="el" href="index.html#arrays">Arrays</a></li>
<li><a class="el" href="index.html#structures">Structures / substructures</a></li>
</ul>
<p><a class="anchor" id="basics"></a> </p>
<h3><a class="anchor" id="autotoc_md20"></a>
The basics</h3>
<p>For SMA-X we use the terms sharing and pulling, instead of the more generic get/set terminology. The intention is to make programmers conscious of the fact that the transactions are not some local access to memory, but that they involve networking, and as such may be subject to unpredictable latencies, network outages, or other errors.</p>
<p>At the lowest level, the library provides two functions accordingly: <code><a class="el" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare()</a></code> and <code><a class="el" href="smax_8c.html#afb7eec789669c3d3f416857d3615ace6">smaxPull()</a></code>, either to send local data to store in SMA-X, or to retrieve data from SMA-X for local use, respectively. There are higher-level functions too, which build on these, providing a simpler API for specific data types, or extra features, such as lazy or pipelined pulls. These will be discussed in the sections below. But, before that, let's look into the basics of how data is handled between you machine local data that you use in your C/C++ application and its machine-independent representation in SMA-X.</p>
<p>Here is an example for a generic sharing of a <code>double[]</code> array from C/C++:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> data[8] = ...   <span class="comment">// your local data</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Share (send) this data to SMA-X as &quot;system:subsystem:some_data&quot;</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;some_data&quot;</span>, X_DOUBLE, 8);</div>
<div class="line"><span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">  <span class="comment">// Ooops, that did not work...</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_aee07f085e12283ad96f42c4d77430880"><div class="ttname"><a href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare</a></div><div class="ttdeci">int smaxShare(const char *table, const char *key, const void *value, XType type, int count)</div><div class="ttdef"><b>Definition</b> smax.c:711</div></div>
</div><!-- fragment --><p>Pulling data back from SMA-X works similarly, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> data[4][2] = ...   <span class="comment">// buffer in which we will receive data</span></div>
<div class="line"><a class="code hl_struct" href="structXMeta.html">XMeta</a> meta;               <span class="comment">// (optional) metadata we can obtain </span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Retrieve &#39;data&#39; from the SMA-X &quot;system:subsystem:some_data&quot;, as 8 doubles</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#afb7eec789669c3d3f416857d3615ace6">smaxPull</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;some_data&quot;</span>, X_DOUBLE, 8, data, &amp;meta);</div>
<div class="line"><span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops, something went wrong...</span></div>
<div class="line">  <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_afb7eec789669c3d3f416857d3615ace6"><div class="ttname"><a href="smax_8c.html#afb7eec789669c3d3f416857d3615ace6">smaxPull</a></div><div class="ttdeci">int smaxPull(const char *table, const char *key, XType type, int count, void *value, XMeta *meta)</div><div class="ttdef"><b>Definition</b> smax.c:640</div></div>
<div class="ttc" id="astructXMeta_html"><div class="ttname"><a href="structXMeta.html">XMeta</a></div><div class="ttdoc">SMA-X standard metadata.</div><div class="ttdef"><b>Definition</b> smax.h:166</div></div>
</div><!-- fragment --><p>The metadata argument is optional, and can be <code>NULL</code> if not required.</p>
<p><a class="anchor" id="metadata"></a> </p>
<h3><a class="anchor" id="autotoc_md21"></a>
Standard metadata</h3>
<p>For every variable (structure or leaf node) in SMA-X there is also a set of essential metadata that is stored in the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> database, which describe the data themselves, such as the native type (at the origin); the size as stored in <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a>; the array dimension and shape; the host (and program) which provided the data; the time it was last updated; and a serial number.</p>
<p>The user of the library has the option to retrieve metadata together with the actual data, and thus gain access to this information. The header file <code><a class="el" href="smax_8h.html">smax.h</a></code> defines the <code>Xmeta</code> type as:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structXMeta.html">XMeta</a> {</div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="structXMeta.html#a6e27f49150e9a14580fb313cc2777e00">status</a>;                       <span class="comment">// Error code or X_SUCCESS.</span></div>
<div class="line">  <a class="code hl_typedefRef" href="../../xchange/apidoc/html/xchange_8h.html#a1c7e02eda23566a7891310fd09307a70">XType</a> <a class="code hl_variable" href="structXMeta.html#ace24d22a3441248636253cdb478de9f7">storeType</a>;                  <span class="comment">// Type of variable as stored.</span></div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="structXMeta.html#a16e4b9723516717d3493c46157701520">storeDim</a>;                     <span class="comment">// Dimensionality of the data as stored.</span></div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="structXMeta.html#adb4556a75a248cce0b72e557c81f8af6">storeSizes</a>[<a class="code hl_defineRef" href="../../xchange/apidoc/html/xchange_8h.html#a910ee1c8cd983bf127f7ca2c705d7894">X_MAX_DIMS</a>];       <span class="comment">// Sizes along each dimension of the data as stored.</span></div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="structXMeta.html#a766b48fdc93d03992939adfa91766703">storeBytes</a>;                   <span class="comment">// Total number of bytes stored.</span></div>
<div class="line">  <span class="keywordtype">char</span> <a class="code hl_variable" href="structXMeta.html#a124de75960ce49e7d4dcbdad9237e128">origin</a>[<a class="code hl_define" href="smax_8h.html#a012a406ddc842479b2aefaa987e6c591">SMAX_ORIGIN_LENGTH</a>];  <span class="comment">// Host name that last modified.</span></div>
<div class="line">  <span class="keyword">struct </span>timespec <a class="code hl_variable" href="structXMeta.html#a2aace03835c4d951b3dee117b328ef87">timestamp</a>;        <span class="comment">// Timestamp of the last modification.</span></div>
<div class="line">  <span class="keywordtype">int</span> <a class="code hl_variable" href="structXMeta.html#a4f4017ce7a39a4da2ed1cf8c4dc7de3f">serial</a>;                       <span class="comment">// Number of times the variable was updated.</span></div>
<div class="line">} <a class="code hl_struct" href="structXMeta.html">XMeta</a>;</div>
<div class="ttc" id="asmax_8h_html_a012a406ddc842479b2aefaa987e6c591"><div class="ttname"><a href="smax_8h.html#a012a406ddc842479b2aefaa987e6c591">SMAX_ORIGIN_LENGTH</a></div><div class="ttdeci">#define SMAX_ORIGIN_LENGTH</div><div class="ttdoc">(bytes) Maximum length of 'origin' meatdata, including termination.</div><div class="ttdef"><b>Definition</b> smax.h:118</div></div>
<div class="ttc" id="astructXMeta_html_a124de75960ce49e7d4dcbdad9237e128"><div class="ttname"><a href="structXMeta.html#a124de75960ce49e7d4dcbdad9237e128">XMeta::origin</a></div><div class="ttdeci">char origin[SMAX_ORIGIN_LENGTH]</div><div class="ttdoc">Host name that last modified.</div><div class="ttdef"><b>Definition</b> smax.h:172</div></div>
<div class="ttc" id="astructXMeta_html_a16e4b9723516717d3493c46157701520"><div class="ttname"><a href="structXMeta.html#a16e4b9723516717d3493c46157701520">XMeta::storeDim</a></div><div class="ttdeci">int storeDim</div><div class="ttdoc">Dimensionality of the data as stored.</div><div class="ttdef"><b>Definition</b> smax.h:169</div></div>
<div class="ttc" id="astructXMeta_html_a2aace03835c4d951b3dee117b328ef87"><div class="ttname"><a href="structXMeta.html#a2aace03835c4d951b3dee117b328ef87">XMeta::timestamp</a></div><div class="ttdeci">struct timespec timestamp</div><div class="ttdoc">Timestamp of the last modification.</div><div class="ttdef"><b>Definition</b> smax.h:173</div></div>
<div class="ttc" id="astructXMeta_html_a4f4017ce7a39a4da2ed1cf8c4dc7de3f"><div class="ttname"><a href="structXMeta.html#a4f4017ce7a39a4da2ed1cf8c4dc7de3f">XMeta::serial</a></div><div class="ttdeci">int serial</div><div class="ttdoc">Number of times the variable was updated.</div><div class="ttdef"><b>Definition</b> smax.h:174</div></div>
<div class="ttc" id="astructXMeta_html_a6e27f49150e9a14580fb313cc2777e00"><div class="ttname"><a href="structXMeta.html#a6e27f49150e9a14580fb313cc2777e00">XMeta::status</a></div><div class="ttdeci">int status</div><div class="ttdoc">Error code or X_SUCCESS.</div><div class="ttdef"><b>Definition</b> smax.h:167</div></div>
<div class="ttc" id="astructXMeta_html_a766b48fdc93d03992939adfa91766703"><div class="ttname"><a href="structXMeta.html#a766b48fdc93d03992939adfa91766703">XMeta::storeBytes</a></div><div class="ttdeci">int storeBytes</div><div class="ttdoc">Total number of bytes stored.</div><div class="ttdef"><b>Definition</b> smax.h:171</div></div>
<div class="ttc" id="astructXMeta_html_ace24d22a3441248636253cdb478de9f7"><div class="ttname"><a href="structXMeta.html#ace24d22a3441248636253cdb478de9f7">XMeta::storeType</a></div><div class="ttdeci">XType storeType</div><div class="ttdoc">Type of variable as stored.</div><div class="ttdef"><b>Definition</b> smax.h:168</div></div>
<div class="ttc" id="astructXMeta_html_adb4556a75a248cce0b72e557c81f8af6"><div class="ttname"><a href="structXMeta.html#adb4556a75a248cce0b72e557c81f8af6">XMeta::storeSizes</a></div><div class="ttdeci">int storeSizes[X_MAX_DIMS]</div><div class="ttdoc">Sizes along each dimension of the data as stored.</div><div class="ttdef"><b>Definition</b> smax.h:170</div></div>
<div class="ttc" id="axchange_8h_html_a1c7e02eda23566a7891310fd09307a70"><div class="ttname"><a href="../../xchange/apidoc/html/xchange_8h.html#a1c7e02eda23566a7891310fd09307a70">XType</a></div><div class="ttdeci">int XType</div></div>
<div class="ttc" id="axchange_8h_html_a910ee1c8cd983bf127f7ca2c705d7894"><div class="ttname"><a href="../../xchange/apidoc/html/xchange_8h.html#a910ee1c8cd983bf127f7ca2c705d7894">X_MAX_DIMS</a></div><div class="ttdeci">#define X_MAX_DIMS</div></div>
</div><!-- fragment --><p><a class="anchor" id="flexible-types-and-sizes"></a> </p>
<h3><a class="anchor" id="autotoc_md22"></a>
Flexible types and sizes</h3>
<p>One nifty feature of the library is that as a consumer you need not be too concerned about what type or size of data the producer provides. The program that produces the data may sometimes change, for example from writing 32-bit floating point types to a 64-bit floating point types. Also while it produced data for say 10 units before (as an array of 10), now it might report for just 9, or perhaps it now reports for 12.</p>
<p>The point is that if your consumer application was written to expect ten 32-bit floating floating point values, it can get that even if the producer changed the exact type or element count since you have written your client. The library will simply apply the necessaty type conversion automatically, and then truncate, or else pad (with zeroes), the data as necessary to get what you want.</p>
<p>The type conversion can be both widening or narrowing. Strings and numerical values can be converted to one another through the expected string representation of numbers and vice versa. Boolean <code>true</code> values are treated equivalently to a numerical value of 1 and all non-zero numerical values will convert to boolean <code>true</code>.</p>
<p>And, if you are concerned about the actual type or size (or shape) of the data stored, you have the option to inspect the metadata, and make decisions based on it. Otherwise, the library will just take care of giving you the available data in the format you expect.</p>
<p><a class="anchor" id="scalars"></a> </p>
<h3><a class="anchor" id="autotoc_md23"></a>
Scalar quantities</h3>
<p>Often enough we deal with scalar quantities (not arrays), such as a single number, boolean value, or a string (yes, we treat strings i.e., <code>char *</code>, as a scalar too!).</p>
<p>Here are some examples of sharing scalars to SMA-X. Easy-peasy:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Put a boolean value into SMA-X</span></div>
<div class="line">status = <a class="code hl_function" href="smax-easy_8c.html#a294640494c2d892dfb4944cd9da7729a">smaxShareBoolean</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;is_online&quot;</span>, TRUE);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Put an integer value into SMA-X</span></div>
<div class="line">status = <a class="code hl_function" href="smax-easy_8c.html#adeb667a3e72acedee7d03eb246b8e1ae">smaxShareInt</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;some_int_value&quot;</span>, 1012);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Put a floating-point value into SMA-X</span></div>
<div class="line">status = <a class="code hl_function" href="smax-easy_8c.html#acfbfd2b9a23305d75e45541c5177e42a">smaxShareDouble</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;some_value&quot;</span>, -3.4032e-11);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Put a string value into SMA-X</span></div>
<div class="line">status = <a class="code hl_function" href="smax-easy_8c.html#a5c9657c01a9b8a324a9a1d318dd18e5b">smaxShareString</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;blah-blah&quot;</span>);</div>
<div class="ttc" id="asmax-easy_8c_html_a294640494c2d892dfb4944cd9da7729a"><div class="ttname"><a href="smax-easy_8c.html#a294640494c2d892dfb4944cd9da7729a">smaxShareBoolean</a></div><div class="ttdeci">int smaxShareBoolean(const char *table, const char *key, boolean value)</div><div class="ttdef"><b>Definition</b> smax-easy.c:430</div></div>
<div class="ttc" id="asmax-easy_8c_html_a5c9657c01a9b8a324a9a1d318dd18e5b"><div class="ttname"><a href="smax-easy_8c.html#a5c9657c01a9b8a324a9a1d318dd18e5b">smaxShareString</a></div><div class="ttdeci">int smaxShareString(const char *table, const char *key, const char *sValue)</div><div class="ttdef"><b>Definition</b> smax-easy.c:463</div></div>
<div class="ttc" id="asmax-easy_8c_html_acfbfd2b9a23305d75e45541c5177e42a"><div class="ttname"><a href="smax-easy_8c.html#acfbfd2b9a23305d75e45541c5177e42a">smaxShareDouble</a></div><div class="ttdeci">int smaxShareDouble(const char *table, const char *key, double value)</div><div class="ttdef"><b>Definition</b> smax-easy.c:447</div></div>
<div class="ttc" id="asmax-easy_8c_html_adeb667a3e72acedee7d03eb246b8e1ae"><div class="ttname"><a href="smax-easy_8c.html#adeb667a3e72acedee7d03eb246b8e1ae">smaxShareInt</a></div><div class="ttdeci">int smaxShareInt(const char *table, const char *key, long long value)</div><div class="ttdef"><b>Definition</b> smax-easy.c:397</div></div>
</div><!-- fragment --><p>Or pulling them from SMA-X:</p>
<div class="fragment"><div class="line"><span class="comment">// Retrieve &quot;system:subsystem:is_online&quot; as a boolean, defaulting to FALSE</span></div>
<div class="line"><span class="keywordtype">boolean</span> isTrue = smaxPullBoolean(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;is_online&quot;</span>, FALSE);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Retrieve &quot;system:subsystem:some_int_value&quot; as an int, with a default value of -1</span></div>
<div class="line"><span class="keywordtype">int</span> c = <a class="code hl_function" href="smax-easy_8c.html#a42685e249ca24359b0f3f2a04a99b16b">smaxPullInt</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;some_int_value&quot;</span>, -1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Retrieve &quot;system:subsystem:some_value&quot; as a double (or else NAN if cannot).</span></div>
<div class="line"><span class="keywordtype">double</span> value = <a class="code hl_function" href="smax-easy_8c.html#aa143c2385f210cdd772f014939e1411e">smaxPullDouble</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;some_value&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span>(!isnan(value)) {    <span class="comment">// check for NAN if need be</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Retrieve &quot;system:subsystem:name&quot; as a 0-terminated C string (or NULL if cannot).</span></div>
<div class="line"><span class="keywordtype">char</span> *str = <a class="code hl_function" href="smax-easy_8c.html#aa143c2385f210cdd772f014939e1411e">smaxPullDouble</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span>(str != NULL) {      <span class="comment">// check for NULL</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Once the pulled string is no longer needed, destroy it.</span></div>
<div class="line">free(str)</div>
<div class="ttc" id="asmax-easy_8c_html_a42685e249ca24359b0f3f2a04a99b16b"><div class="ttname"><a href="smax-easy_8c.html#a42685e249ca24359b0f3f2a04a99b16b">smaxPullInt</a></div><div class="ttdeci">int smaxPullInt(const char *table, const char *key, int defaultValue)</div><div class="ttdef"><b>Definition</b> smax-easy.c:324</div></div>
<div class="ttc" id="asmax-easy_8c_html_aa143c2385f210cdd772f014939e1411e"><div class="ttname"><a href="smax-easy_8c.html#aa143c2385f210cdd772f014939e1411e">smaxPullDouble</a></div><div class="ttdeci">double smaxPullDouble(const char *table, const char *key)</div><div class="ttdef"><b>Definition</b> smax-easy.c:362</div></div>
</div><!-- fragment --><p><a class="anchor" id="arrays"></a> </p>
<h3><a class="anchor" id="autotoc_md24"></a>
Arrays</h3>
<p>The generic <code><a class="el" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare()</a></code> function readily handles 1D arrays, and the <code><a class="el" href="smax_8c.html#afb7eec789669c3d3f416857d3615ace6">smaxPull()</a></code> handles native (monolithic) arrays of all types (e.g. <code>double[][]</code>, or <code>boolean[][][]</code>). However, you may want to share multidimensional arrays, noting their specific shapes, or else pull array data for which you may not know in advance what size (or shape) of the storage needed locally for the values stored in SMA-X for some variable. For these reasons, the library provides a set of functions to make the handling of arrays a simpler too.</p>
<p>Let's begin with sharing multi-dimensional arrays. Instead of <code><a class="el" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare()</a></code>, you can use <code><a class="el" href="smax_8c.html#a1b116e8ffa85c30991ce6d8afb0319e0">smaxShareArray()</a></code> which allows you to define the multi-dimensional shape of the data beyond just the number of elements stored. E.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">float</span> data[4][2] = ...    <span class="comment">// Your local 2D data array</span></div>
<div class="line"><span class="keywordtype">int</span> shape[] = { 4, 2 };   <span class="comment">// The array shape as stored in SMA-X</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#a1b116e8ffa85c30991ce6d8afb0319e0">smaxShareArray</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;my_2d_array&quot;</span>, X_FLOAT, 2, shape);</div>
<div class="line"><span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops, did not work...</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_a1b116e8ffa85c30991ce6d8afb0319e0"><div class="ttname"><a href="smax_8c.html#a1b116e8ffa85c30991ce6d8afb0319e0">smaxShareArray</a></div><div class="ttdeci">int smaxShareArray(const char *table, const char *key, const void *ptr, XType type, int ndim, const int *sizes)</div><div class="ttdef"><b>Definition</b> smax.c:738</div></div>
</div><!-- fragment --><p>Note, that the dimensions of how the data is stored in SMA-X is determined solely by the '2' dimensions specified as the 4th argument and the corresponding 2 elements in the <code>shape</code> array. The <code>data</code> could have been any pointer to an array of floats containing at least the required number of element (8 in the example above).</p>
<p>For 1D arrays, you have some convenience methods for sharing specific types. These can be convenient because they eliminate one potential source of bugs, where the type argument to <code><a class="el" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare()</a></code> does not match the pointer type of the data. Using, say, <code><a class="el" href="smax-easy_8c.html#ace410207bfb5ba9211dc644f7dd2768d">smaxShareFloats()</a></code> instead to share a 1D floating-point array instead of the generic <code><a class="el" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare()</a></code> will allow the compiler to check and warn you if the data array is not the <code>float *</code> type. E.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">float</span> *data = ...  <span class="comment">// pointer to a one or higher-dimensional C array of floats.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send N elements from data to SMA-X as &quot;system:subsystem:my_array&quot;</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-easy_8c.html#ace410207bfb5ba9211dc644f7dd2768d">smaxShareFloats</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;my_array&quot;</span>, data, N);</div>
<div class="line"><span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops, did not work...</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax-easy_8c_html_ace410207bfb5ba9211dc644f7dd2768d"><div class="ttname"><a href="smax-easy_8c.html#ace410207bfb5ba9211dc644f7dd2768d">smaxShareFloats</a></div><div class="ttdeci">int smaxShareFloats(const char *table, const char *key, const float *values, int n)</div><div class="ttdef"><b>Definition</b> smax-easy.c:580</div></div>
</div><!-- fragment --><p>Similar functions are available for every built-in type (primitives, plus strings and booleans). For pulling arrays without knowing a-priori the element count or shape, there are also convenience functions, such as:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structXMeta.html">XMeta</a> meta;    <span class="comment">// (optional) we&#39;ll return the metadata in this</span></div>
<div class="line"><span class="keywordtype">int</span> status;    <span class="comment">// we&#39;ll return the status in this</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get whatever data is in &quot;system:subsystem:my_array&quot; as doubles.</span></div>
<div class="line"><span class="keywordtype">double</span> *data = <a class="code hl_function" href="smax-easy_8c.html#a6e5df36b7eee3944b1ef07edb7f9647d">smaxPullDoubles</a>(<span class="stringliteral">&quot;system:subsystem&quot;</span>, <span class="stringliteral">&quot;my_array&quot;</span>, &amp;meta, &amp;status);</div>
<div class="line"><span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops, we got an error</span></div>
<div class="line">} </div>
<div class="line"><span class="keywordflow">if</span>(data == NULL) {</div>
<div class="line">  <span class="comment">// Oops the data is NULL</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// When done using the data we obtained, destroy it.</span></div>
<div class="line">free(data);</div>
<div class="ttc" id="asmax-easy_8c_html_a6e5df36b7eee3944b1ef07edb7f9647d"><div class="ttname"><a href="smax-easy_8c.html#a6e5df36b7eee3944b1ef07edb7f9647d">smaxPullDoubles</a></div><div class="ttdeci">double * smaxPullDoubles(const char *table, const char *key, XMeta *meta, int *n)</div><div class="ttdef"><b>Definition</b> smax-easy.c:209</div></div>
</div><!-- fragment --><p>As illustrated, the above will return a dynamically allocated array with the required size to hold the data, and the size and shape of the data is returned in the metadata that was also supplied with the call. After using the returned data (and ensuring that it is not <code>NULL</code>), you should always call <code>free()</code> on it to avoid memory leaks in your application.</p>
<p><a class="anchor" id="structures"></a> </p>
<h3><a class="anchor" id="autotoc_md25"></a>
Structures / substructures...</h3>
<p>You can share entire data structures, represented by an appropriate <code><a class="elRef" href="../../xchange/apidoc/html/structXStructure.html">XStructure</a></code> type (see the <b>xchange</b> library for a description and usage):</p>
<div class="fragment"><div class="line"><a class="code hl_structRef" href="../../xchange/apidoc/html/structXStructure.html">XStructure</a> s = ...   <span class="comment">// The structured data you have prepared locally.</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#ab6a1590c953abc1c37fed841cd3a903a">smaxShareStruct</a>(<span class="stringliteral">&quot;syste:subsystem&quot;</span>, &amp;s);</div>
<div class="line"><span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops, something did not work</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_ab6a1590c953abc1c37fed841cd3a903a"><div class="ttname"><a href="smax_8c.html#ab6a1590c953abc1c37fed841cd3a903a">smaxShareStruct</a></div><div class="ttdeci">int smaxShareStruct(const char *id, const XStructure *s)</div><div class="ttdef"><b>Definition</b> smax.c:869</div></div>
<div class="ttc" id="astructXStructure_html"><div class="ttname"><a href="../../xchange/apidoc/html/structXStructure.html">XStructure</a></div></div>
</div><!-- fragment --><p>Or, you can read a structure, including all embedded substructures in it, with <code><a class="el" href="smax-easy_8c.html#a30a2212f19ab2cbf60ea348110475948">smaxPullStruct()</a></code>:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structXMeta.html">XMeta</a> meta;</div>
<div class="line"><span class="keywordtype">int</span> nElements;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_structRef" href="../../xchange/apidoc/html/structXStructure.html">XStructure</a> *s = <a class="code hl_function" href="smax-easy_8c.html#a30a2212f19ab2cbf60ea348110475948">smaxPullStruct</a>(<span class="stringliteral">&quot;system&quot;</span>, <span class="stringliteral">&quot;subsystem&quot;</span>, &amp;meta, &amp;n);</div>
<div class="line"><span class="keywordflow">if</span>(n &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops there was an error...</span></div>
<div class="line">  <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> value = <a class="code hl_function" href="smax-easy_8c.html#ab7c45d4512c22c24153763aa9e227b68">smaxGetDoubleField</a>(s, <span class="stringliteral">&quot;some_value&quot;</span>, 0.0);</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Once the pulled structure is no longer needed, destroy it...</span></div>
<div class="line">xDestroyStruct(s);</div>
<div class="ttc" id="asmax-easy_8c_html_a30a2212f19ab2cbf60ea348110475948"><div class="ttname"><a href="smax-easy_8c.html#a30a2212f19ab2cbf60ea348110475948">smaxPullStruct</a></div><div class="ttdeci">XStructure * smaxPullStruct(const char *id, XMeta *meta, int *status)</div><div class="ttdef"><b>Definition</b> smax-easy.c:68</div></div>
<div class="ttc" id="asmax-easy_8c_html_ab7c45d4512c22c24153763aa9e227b68"><div class="ttname"><a href="smax-easy_8c.html#ab7c45d4512c22c24153763aa9e227b68">smaxGetDoubleField</a></div><div class="ttdeci">double smaxGetDoubleField(const XStructure *s, const char *name, double defaultValue)</div><div class="ttdef"><b>Definition</b> smax-easy.c:825</div></div>
</div><!-- fragment --><p>Note, that the structure returned by <code><a class="el" href="smax-easy_8c.html#a30a2212f19ab2cbf60ea348110475948">smaxPullStruct()</a></code> is in the serialized format of SMA-X. That is, all leaf nodes are stored as strings, just as they appear in the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> database. Hence, we used the <code>smaxGet...Field()</code> methods above to deserialize the leaf nodes as needed on demand. If you want to use the methods of <b>xchange</b> to access the structure, you will need to convert to binary format first, using <code><a class="el" href="smax-util_8c.html#a50fef3b0daf40f7de6f52b05abd2963c">smax2xStruct(XStructure *)</a></code>.</p>
<p>Note also, that pulling large structures can be an expensive operation on the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server, and may block the server for longer than usual periods, causing latencies for other programs that use SMA-X. It's best to use this method for smallish structures only (with, say, a hundred or so or fewer leaf nodes).</p>
<hr  />
<p><a class="anchor" id="lazy-pulling"></a> </p>
<h2><a class="anchor" id="autotoc_md27"></a>
Lazy pulling (high-frequency queries)</h2>
<p>What happens if you need the data frequently? Do you pound on the database at some high-frequency? No, you probably no not want to do that, especially if the data you need is not necessaily changing fast. There is no point on wasting network bandwidth only to return the same values again and again. This is where 'lazy' pulling excels.</p>
<p>From the caller's perspective lazy pulling works just like regular SMA-X pulls, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> data[10][4][2];</div>
<div class="line"><span class="keywordtype">int</span> sizes[] = { 10, 4, 2 };</div>
<div class="line"><a class="code hl_struct" href="structXMeta.html">XMeta</a> meta;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-lazy_8c.html#ab50222d7bbaa985fd6d004d67b0269ce">smaxLazyPull</a>(<span class="stringliteral">&quot;some_table&quot;</span>, <span class="stringliteral">&quot;some_data&quot;</span>, X_INT, 3, sizes, data, &amp;meta);</div>
<div class="ttc" id="asmax-lazy_8c_html_ab50222d7bbaa985fd6d004d67b0269ce"><div class="ttname"><a href="smax-lazy_8c.html#ab50222d7bbaa985fd6d004d67b0269ce">smaxLazyPull</a></div><div class="ttdeci">int smaxLazyPull(const char *table, const char *key, XType type, int count, void *value, XMeta *meta)</div><div class="ttdef"><b>Definition</b> smax-lazy.c:439</div></div>
</div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-lazy_8c.html#a31ed83292a29d69e1c9635b21aae7561">smaxLazyPullDouble</a>(<span class="stringliteral">&quot;some_table&quot;</span>, <span class="stringliteral">&quot;some_var&quot;</span>);</div>
<div class="ttc" id="asmax-lazy_8c_html_a31ed83292a29d69e1c9635b21aae7561"><div class="ttname"><a href="smax-lazy_8c.html#a31ed83292a29d69e1c9635b21aae7561">smaxLazyPullDouble</a></div><div class="ttdeci">double smaxLazyPullDouble(const char *table, const char *key)</div><div class="ttdef"><b>Definition</b> smax-lazy.c:487</div></div>
</div><!-- fragment --><p>But, under the hood, it does something different. The first time a new variable is lazy pulled it is fetched from the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> database just like a regular pull. But, it also will cache the value, and watch for update notifications from the SMA-X server. Thus, as long as no update notification is received, successive calls will simply return the locally cached value. This can save big on network usage, and also provides orders of magnitude faster access so long as the variable remains unchanged.</p>
<p>When the vatiable is updated in SMA-X, our client library will be notified, and one of two things can happen:</p>
<ol type="1">
<li>it invalidates the cache, so that the next lazy pull will again work just like a regular pull, fetching the updated value from SMA-X on demand. And again the library will cache that value and watch for notifications for the next update. Or,</li>
<li>it will trigger a background process to update the cached value in the background with a pipelined (high-throughput) pull. However, until the new value is actually fetched, it will return the previously cached value promptly.</li>
</ol>
<p>The choice between the two is yours, and you can control which suits your need best. The default behavior for lazy pulls is (1), but you may call <code><a class="el" href="smax-lazy_8c.html#a18027e41c40722011815bc878857e3d0">smaxLazyCache()</a></code> after the first pull of a variable, to indicate that you want to enable background cache updates (2) for it. The advantage of (1) is that it will never serve you outdated data even if there are significant network latencies &ndash; but you may have to wait a little to fetch updates. On the other hand (2) will always provide a recent value with effectively no latency, but this value may be outdated if there are delays on the network updating the cache. The difference is typically at the micro-seconds level on a local LAN. However, (2) may be preferable when you need to access SMA-X data from timing critical code blocks, where it is more important to ensure that the value is returned quickly, rather than whether it is a millisecond too old or not.</p>
<p>In either case, when you are done using lazy variables, you should let the library know that it no longer needs to watch updates for these, by calling either <code><a class="el" href="smax-lazy_8c.html#a167a60b494fa9ec5b046f9da796f18b5">smaxLazyEnd()</a></code> on specific variables, or else <code><a class="el" href="smax-lazy_8c.html#af3d0cff3f8a6ab745907f4544981fdd1">smaxLazyFlush()</a></code> to stop watching updates for all lazy variables. (A successive lazy pull will automatically start watching for updates again, in case you wish to re-enable).</p>
<div class="fragment"><div class="line"><span class="comment">// Lazy pull a bunch of data (typically in a loop).</span></div>
<div class="line"><span class="keywordflow">for</span>(...) {</div>
<div class="line">  <a class="code hl_function" href="smax-lazy_8c.html#ab50222d7bbaa985fd6d004d67b0269ce">smaxLazyPull</a>(<span class="stringliteral">&quot;some_table&quot;</span>, <span class="stringliteral">&quot;some_var&quot;</span>, ...);</div>
<div class="line">  smaxLaxyPull(...);</div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Once we do not need &quot;some_table:some_var&quot; any more:</span></div>
<div class="line"><a class="code hl_function" href="smax-lazy_8c.html#a167a60b494fa9ec5b046f9da796f18b5">smaxLazyEnd</a>(<span class="stringliteral">&quot;some_table&quot;</span>, <span class="stringliteral">&quot;some_var&quot;</span>);</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// And to stop lazy accessing all</span></div>
<div class="line">smaxLazyFlush();</div>
<div class="ttc" id="asmax-lazy_8c_html_a167a60b494fa9ec5b046f9da796f18b5"><div class="ttname"><a href="smax-lazy_8c.html#a167a60b494fa9ec5b046f9da796f18b5">smaxLazyEnd</a></div><div class="ttdeci">int smaxLazyEnd(const char *table, const char *key)</div><div class="ttdef"><b>Definition</b> smax-lazy.c:597</div></div>
</div><!-- fragment --><hr  />
<p><a class="anchor" id="pipelined-pulls"></a> </p>
<h2><a class="anchor" id="autotoc_md29"></a>
Pipelined pulling (high volume queries)</h2>
<ul>
<li><a class="el" href="index.html#lazy-synchronization">Synchronization points and waiting</a></li>
<li><a class="el" href="index.html#lazy-callbacks">Callbacks</a></li>
<li><a class="el" href="index.html#lazy-finish">Finishing up</a></li>
</ul>
<p>The regular pulling of data from SMA-X requires a separate round-trip for each and every request. That is, successive pulls are sent only after the responses from the prior pull has been received. A lot of the time is spent on waiting for responses to come back. With round trip times in the 100 &mu;s range, this means that this method of fetching data from SMA-X is suitable for obtaining at most a a few thousand values per second.</p>
<p>However, sometimes you want to get access to a large number of values faster. This is what pipelined pulling is for. In pipelined mode, a batch of pull requests are sent to the SMA-X <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server in quick succession, without waiting for responses. The values, when received are processed by a dedicated background thread. And, the user has an option of either waiting until all data is collected, or ask for as callback when the data is ready.</p>
<p>Again it works similarly to the basic pulling, except that you submit your pull request to a queue with <code><a class="el" href="smax-queue_8c.html#a2c71427a215e2253d93de24788db338d">smaxQueue()</a></code>. For example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> d; <span class="comment">// A value we will fill</span></div>
<div class="line"><a class="code hl_struct" href="structXMeta.html">XMeta</a> meta;   <span class="comment">// (optional) metadata to fill (for the above value).</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-queue_8c.html#a2c71427a215e2253d93de24788db338d">smaxQueue</a>(<span class="stringliteral">&quot;some_table&quot;</span>, <span class="stringliteral">&quot;some_var&quot;</span>, X_DOUBLE, 1, &amp;d, &amp;meta);</div>
<div class="ttc" id="asmax-queue_8c_html_a2c71427a215e2253d93de24788db338d"><div class="ttname"><a href="smax-queue_8c.html#a2c71427a215e2253d93de24788db338d">smaxQueue</a></div><div class="ttdeci">int smaxQueue(const char *table, const char *key, XType type, int count, void *value, XMeta *meta)</div><div class="ttdef"><b>Definition</b> smax-queue.c:490</div></div>
</div><!-- fragment --><p>Pipelined (batched) pulls have dramatic effects on performance. Rather than being limited by round-trip times, you will be limited by the performance of the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server itself (or the network bandwidth on some older infrastructure). As such, instead of thousand of queries per second, you can pull 2-3 orders of magnitude more in a given time, with hudreds of thousands to even millions of pull per second this way.</p>
<p><a class="anchor" id="lazy-synchronization"></a> </p>
<h3><a class="anchor" id="autotoc_md30"></a>
Synchronization points and waiting</h3>
<p>After you have submitted a batch of pull request to the queue, you can create a synchronization point as:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structXSyncPoint.html">XSyncPoint</a> *syncPoint = <a class="code hl_function" href="smax-queue_8c.html#a30e2e1eb462ed2274a55016830b9abc1">smaxCreateSyncPoint</a>();</div>
<div class="ttc" id="asmax-queue_8c_html_a30e2e1eb462ed2274a55016830b9abc1"><div class="ttname"><a href="smax-queue_8c.html#a30e2e1eb462ed2274a55016830b9abc1">smaxCreateSyncPoint</a></div><div class="ttdeci">XSyncPoint * smaxCreateSyncPoint()</div><div class="ttdef"><b>Definition</b> smax-queue.c:71</div></div>
<div class="ttc" id="astructXSyncPoint_html"><div class="ttname"><a href="structXSyncPoint.html">XSyncPoint</a></div><div class="ttdoc">Synchronization point that can be waited upon when queueing pipelined pulls.</div><div class="ttdef"><b>Definition</b> smax.h:128</div></div>
</div><!-- fragment --><p>A synchronization point is a marker in the queue that we can wait on. After the synchronization point is created, you can sumbit more pull request to the same queue (e.g. for another processing block), or do some other things for a bit (since it will take at least some microseconds before the data is ready). Then, when ready you can wait on the specific synchronization point to ensure that data submitted prior to its creation is delivered from SMA-X:</p>
<div class="fragment"><div class="line"><span class="comment">// Wait for data submitted prior to syncPoint to be ready, or time out after 1000 ms.</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-queue_8c.html#a90a901b9e649c77d29379b8fc31cbefc">smaxSync</a>(syncPoint, 1000);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destroy the synchronization point if we no longer need it.</span></div>
<div class="line">xDestroySyncPoint(syncPoint);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check return status...</span></div>
<div class="line"><span class="keywordflow">if</span>(status == X_TIMEOUT) {</div>
<div class="line">  <span class="comment">// We timed out</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">  <span class="comment">// Some other error</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax-queue_8c_html_a90a901b9e649c77d29379b8fc31cbefc"><div class="ttname"><a href="smax-queue_8c.html#a90a901b9e649c77d29379b8fc31cbefc">smaxSync</a></div><div class="ttdeci">int smaxSync(XSyncPoint *sync, int timeoutMillis)</div><div class="ttdef"><b>Definition</b> smax-queue.c:251</div></div>
</div><!-- fragment --><p><a class="anchor" id="lazy-callbacks"></a> </p>
<h3><a class="anchor" id="autotoc_md31"></a>
Callbacks</h3>
<p>The alternative to synchronization points and waiting, is to provide a callback function, which will process your data as soon as it is available, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> my_pull_processor(<span class="keywordtype">void</span> *arg) {</div>
<div class="line">   <span class="comment">// Say, we expect a string tag passed along to identify what we need to process...</span></div>
<div class="line">   <span class="keywordtype">char</span> *tag = (<span class="keywordtype">char</span> *) arg;</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Do what we need to do...</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>Then submit this callback routine to the queue after the set of variables it requires with:</p>
<div class="fragment"><div class="line"><span class="comment">// We&#39;ll call my_pull_processor, with the argument &quot;some_tag&quot;, when prior data has arrived.</span></div>
<div class="line"><a class="code hl_function" href="smax-queue_8c.html#a06781e13ee30b0530ba3ed2e4436b449">smaxQueueCallback</a>(my_pull_processor, <span class="stringliteral">&quot;some_tag&quot;</span>);</div>
<div class="ttc" id="asmax-queue_8c_html_a06781e13ee30b0530ba3ed2e4436b449"><div class="ttname"><a href="smax-queue_8c.html#a06781e13ee30b0530ba3ed2e4436b449">smaxQueueCallback</a></div><div class="ttdeci">int smaxQueueCallback(void(*f)(void *), void *arg)</div><div class="ttdef"><b>Definition</b> smax-queue.c:145</div></div>
</div><!-- fragment --><p><a class="anchor" id="lazy-finish"></a> </p>
<h3><a class="anchor" id="autotoc_md32"></a>
Finishing up</h3>
<p>If you might still have some pending pipelined pulls that have not received responses yet, you may want to wait until all previously sumbitted requests have been collected. You can do that with:</p>
<div class="fragment"><div class="line"><span class="comment">// Wait for up to 3000 ms for all pipelined pulls to collect responses from SMA-X.</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-queue_8c.html#a065361085eed93188b7fd3ffe3a7eaf5">smaxWaitQueueComplete</a>(3000);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check return status...</span></div>
<div class="line"><span class="keywordflow">if</span>(status == X_TIMEOUT) {</div>
<div class="line">  <span class="comment">// We timed out</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span>(status &lt; 0) {</div>
<div class="line">  <span class="comment">// Some other error</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax-queue_8c_html_a065361085eed93188b7fd3ffe3a7eaf5"><div class="ttname"><a href="smax-queue_8c.html#a065361085eed93188b7fd3ffe3a7eaf5">smaxWaitQueueComplete</a></div><div class="ttdeci">int smaxWaitQueueComplete(int timeoutMillis)</div><div class="ttdef"><b>Definition</b> smax-queue.c:326</div></div>
</div><!-- fragment --><hr  />
<p><a class="anchor" id="notifications"></a> </p>
<h2><a class="anchor" id="autotoc_md34"></a>
Custom notifications and update handling</h2>
<ul>
<li><a class="el" href="index.html#monitoring-updates">Monitoring updates</a></li>
<li><a class="el" href="index.html#waiting-for-updates">Waiting for updates</a></li>
<li><a class="el" href="index.html#update-callbacks">Update callbacks</a></li>
</ul>
<p><a class="anchor" id="monitoring-updates"></a> </p>
<h3><a class="anchor" id="autotoc_md35"></a>
Monitoring updates</h3>
<p>The LUA scripts that define SMA-X interface on the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> server send out PUB/SUB notifications for every variable on their own dedicate PUB/SUB channel whenever the variable is updated. Byt default, lazy access methods subscribe to these messages and use them to determine when to invalidate the chache and fetch new values from the database again. However, you may subscribe and use these messages outside of the lazy update routines also. The only thing you need to pay attention to is not to unsubscribe from update notifications for those variables that have multiple active monitors (including lazy updates).</p>
<p>One common use case is that you want to execute some code in your application when some value changes in SMA-X. You can do that easily, and have two choices on how you want to trigger the code execution: (1) you can block execution of your current thread until an update notification is received for one of the variables (or patterns) of interest to which you have subscribed, or (2) you can let <b>smax_clib</b> call a designated function of your application when such an update notification is captured. We'll cover these two cases separately below.</p>
<p>However, in either case you will have to subscribe to the variable(s) or pattern(s) of interest with <code><a class="el" href="smax_8c.html#a53614ba57a594135c13b64a2d89eaa43">smaxSubscribe()</a></code> before updates can be processed, e.g.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#a53614ba57a594135c13b64a2d89eaa43">smaxSubscribe</a>(<span class="stringliteral">&quot;some_table&quot;</span>, <span class="stringliteral">&quot;watch_point_variable&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">  <span class="comment">// Ooops something did not go to plan</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_a53614ba57a594135c13b64a2d89eaa43"><div class="ttname"><a href="smax_8c.html#a53614ba57a594135c13b64a2d89eaa43">smaxSubscribe</a></div><div class="ttdeci">int smaxSubscribe(const char *table, const char *key)</div><div class="ttdef"><b>Definition</b> smax.c:913</div></div>
</div><!-- fragment --><p>and/or pattern(s)</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#a53614ba57a594135c13b64a2d89eaa43">smaxSubscribe</a>(<span class="stringliteral">&quot;watch_*&quot;</span>, <span class="stringliteral">&quot;watch_[a-z]_*&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">  <span class="comment">// Ooops something did not go to plan</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can subscribe to any number of variables or patterns in this way. <b>smax_clib</b> will receive and process notifications for all of them. (So beware of creating unneccessary network traffic.)</p>
<p><a class="anchor" id="waiting-for-updates"></a> </p>
<h3><a class="anchor" id="autotoc_md36"></a>
Waiting for updates</h3>
<p>The first option for executing code conditional on some variable update is to block execution in the current thread and wait until the variable(s) of interest change(s) (or until some timeout limit is reached). There is a group of functions <code>smaxWaitOn...()</code> that do exactly that. For example:</p>
<div class="fragment"><div class="line"><span class="comment">// Wait for watch_foo:watch_h_bar to update, or wait at most 500 ms</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax-easy_8c.html#af54b8b5d2e79eda86b3349c3c138331c">smaxWaitOnSubscribedVar</a>(<span class="stringliteral">&quot;watch_foo&quot;</span>, <span class="stringliteral">&quot;watch_h_bar&quot;</span>, 500);</div>
<div class="line"><span class="keywordflow">if</span> (status == X_TIMEDOUT) {</div>
<div class="line">  <span class="comment">// Wait timed out, maybe we want to try again, or do something else...</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">  <span class="comment">// Oh no, some other error happened.</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="line">...</div>
<div class="ttc" id="asmax-easy_8c_html_af54b8b5d2e79eda86b3349c3c138331c"><div class="ttname"><a href="smax-easy_8c.html#af54b8b5d2e79eda86b3349c3c138331c">smaxWaitOnSubscribedVar</a></div><div class="ttdeci">int smaxWaitOnSubscribedVar(const char *matchKey, char **changedTable, int timeout)</div><div class="ttdef"><b>Definition</b> smax-easy.c:976</div></div>
</div><!-- fragment --><p>Similar methods allow you to wait for updates on any subscribed variable in selected tables, or the update of select variables in all subscribed tables, or any of the subscribed variables to change for the wait to end normally (with return value 0).</p>
<p><a class="anchor" id="update-callbacks"></a> </p>
<h3><a class="anchor" id="autotoc_md37"></a>
Update callbacks</h3>
<p>Sometimes, you don't want to block execution, but you want to make sure some code executes when the a variable or variables of interest get updated. For such cases you can designate your own <code>RedisSubscriberCall</code> callback function, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> my_update_processor(<span class="keyword">const</span> <span class="keywordtype">char</span> *pattern, <span class="keyword">const</span> <span class="keywordtype">char</span> *channel, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg, <span class="keywordtype">long</span> len) {</div>
<div class="line">   <span class="keyword">const</span> <span class="keywordtype">char</span> *varID;  <span class="comment">// The variable aggregate ID. </span></div>
<div class="line"> </div>
<div class="line">   <span class="comment">// check that it&#39;s a SMA-X update -- channel should begin with SMAX_UPDATE</span></div>
<div class="line">   <span class="keywordflow">if</span> (strncmp(channel, SMAX_UPDATE, SMAX_UPDATE_LENGTH) != 0) {</div>
<div class="line">     <span class="comment">// Not an SMA-X variable update. It&#39;s not what we expected.</span></div>
<div class="line">     <span class="keywordflow">return</span>;</div>
<div class="line">   }</div>
<div class="line">   </div>
<div class="line">   <span class="keywordtype">id</span> = &amp;channel[SMAX_UPDATE_LENGTH];</div>
<div class="line">   <span class="comment">// Now we can check the ID to see which of the variables updated, and act accordingly.</span></div>
<div class="line">   ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>Once you have defined your callback function, you can activate it with <code><a class="el" href="smax_8c.html#a827dd87397943f3384605f87116b630c">smaxAddSubscriber()</a></code>, e.g.:</p>
<div class="fragment"><div class="line"><span class="comment">// Call my_update_processor on updates for any subscribed variable whose table name starts with &quot;watch_table_&quot;</span></div>
<div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#a827dd87397943f3384605f87116b630c">smaxAddSubscriber</a>(<span class="stringliteral">&quot;watch_table_&quot;</span>, my_update_processor);</div>
<div class="line"><span class="keywordflow">if</span> (status &lt; 0) {</div>
<div class="line">  <span class="comment">// Did not go to plan.</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax_8c_html_a827dd87397943f3384605f87116b630c"><div class="ttname"><a href="smax_8c.html#a827dd87397943f3384605f87116b630c">smaxAddSubscriber</a></div><div class="ttdeci">int smaxAddSubscriber(const char *idStem, RedisSubscriberCall f)</div><div class="ttdef"><b>Definition</b> smax.c:968</div></div>
</div><!-- fragment --><p>When you no longer need to process such updates, you can simply remove the function from being called via <code>smaxRemoveSubscriber()</code>, and if you are absolutely sure that no other part of your code needs the subscription(s) that could trigger it, you can also unsubscribe from the trigger variables/pattern to eliminate unnecessary network traffic.</p>
<p>One word of caution on callbacks is that they are expected to:</p>
<ul>
<li>execute quickly</li>
<li>never block for prolonged periods. (It may be OK to wait briefly on a mutex, provided nothing else can hog that mutex for prolonged periods).</li>
</ul>
<p>If the above two conditions cannot be guaranteed, it's best practice for your callback to place a copy of the callback information on a queue, and then spawn or notify a separate thread to process the infomation in the background, including discarding the copied data if it's no longer needed. Alternatively, you can launch a decicated processor thread early on, and iside it wait for the updates before executing some complex action. The choice is yours.</p>
<hr  />
<p><a class="anchor" id="status-messages"></a> <br  />
 </p>
<h2><a class="anchor" id="autotoc_md39"></a>
Program status / error messages via SMA-X</h2>
<ul>
<li><a class="el" href="index.html#broadcasting-messages">Broadcasting status messages from an application</a></li>
<li><a class="el" href="index.html#processing-messages">Processing program messages</a></li>
</ul>
<p>SMA-X also provides a standard for reporting porgram status, warning, and error messages via the <a class="elRef" href="../../redisx/apidoc/html/structRedis.html">Redis</a> PUB/SUB infrastructure.</p>
<p><a class="anchor" id="broadcasting-messages"></a> </p>
<h3><a class="anchor" id="autotoc_md40"></a>
Broadcasting status messages from an application</h3>
<p>Broadcasting program messages to SMA-X is very simple using a set of dedicated messaging functions by message type. These are:</p>
<p>| <b>smax_clib</b> function | Description | | <code><a class="el" href="smax-messages_8c.html#a02c52082bf38f02dd47b563684e8208e">smaxSendStatus(const char *msg, ...)</a></code> | sends a status message | | <code><a class="el" href="smax-messages_8c.html#af28f27177a145167d0289586c9bf9739">smaxSendInfo(const char *msg, ...)</a></code> | sends an informational message | | <code><a class="el" href="smax-messages_8c.html#a4fdf286d99a08358832702c3f31a88b3">smaxSendDetail(const char *msg, ...)</a></code> | sends optional status/information detail | | <code><a class="el" href="smax-messages_8c.html#a1e7fa44ff0842c8ce3b49971511b950a">smaxSendDebug(const char *msg, ...)</a></code> | sends a debugging messages | | <code><a class="el" href="smax-messages_8c.html#a1c90a439b48a53555e9cfb60ce1b9102">smaxSendWarning(const char *msg, ...)</a></code> | sends a warning message | | <code><a class="el" href="smax-messages_8c.html#aeb4adbc4c56cbf31bc6f94054512e241">smaxSendError(const char *msg, ...)</a></code> | sends an error message | | <code><a class="el" href="smax-messages_8c.html#ad41c05eabbc4fb669430cd638a06c826">smaxSendProgress(double fraction, const char *msg, ...)</a></code> | sends a progress update and message |</p>
<p>All the above methods work like <code>printf()</code>, and can take additional parameters corresponding to the format specifiers contained in the <code>msg</code> argument.</p>
<p>By default, the messages are sent under the canonocal program name (i.e. set by <code>_progname</code> on GNU/Linux systems) that produced the message. You can override that, and define a custom sender ID for your status messages, by calling <code><a class="el" href="smax-messages_8c.html#af3e8295bb941f68cf3177c79cd5fb4d3">smaxSetMessageSenderID()</a></code> prior to broadcasting, e.g.:</p>
<div class="fragment"><div class="line"><span class="comment">// Set out sender ID to &quot;my_program_id&quot;</span></div>
<div class="line"><a class="code hl_function" href="smax-messages_8c.html#af3e8295bb941f68cf3177c79cd5fb4d3">smaxSetMessageSenderID</a>(<span class="stringliteral">&quot;my_program_id&quot;</span>);</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Broadcast a warning message for &quot;my_program_id&quot;</span></div>
<div class="line">int status = <a class="code hl_function" href="smax-messages_8c.html#a1c90a439b48a53555e9cfb60ce1b9102">smaxSendWarning</a>(<span class="stringliteral">&quot;Something did not work&quot;</span> %s<span class="stringliteral">&quot;, explanation);</span></div>
<div class="ttc" id="asmax-messages_8c_html_a1c90a439b48a53555e9cfb60ce1b9102"><div class="ttname"><a href="smax-messages_8c.html#a1c90a439b48a53555e9cfb60ce1b9102">smaxSendWarning</a></div><div class="ttdeci">int smaxSendWarning(const char *msg,...)</div><div class="ttdef"><b>Definition</b> smax-messages.c:207</div></div>
<div class="ttc" id="asmax-messages_8c_html_af3e8295bb941f68cf3177c79cd5fb4d3"><div class="ttname"><a href="smax-messages_8c.html#af3e8295bb941f68cf3177c79cd5fb4d3">smaxSetMessageSenderID</a></div><div class="ttdeci">void smaxSetMessageSenderID(const char *id)</div><div class="ttdef"><b>Definition</b> smax-messages.c:106</div></div>
</div><!-- fragment --><p><a class="anchor" id="processing-messages"></a> </p>
<h3><a class="anchor" id="autotoc_md41"></a>
Processing program messages</h3>
<p>On the receiving end, other applications can process such program messages, for a selection of hosts, programs, and message types. You need to prepare you message processor function(s) first, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> my_message_processor(<a class="code hl_struct" href="structXMessage.html">XMessage</a> *m) {</div>
<div class="line">  printf(<span class="stringliteral">&quot;Received %s message from %s: %s\n&quot;</span>, m-&gt;<a class="code hl_variable" href="structXMessage.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, m-&gt;<a class="code hl_variable" href="structXMessage.html#acc6113e98e7cd24d9dcfa520749a5d3f">prog</a>, m-&gt;<a class="code hl_variable" href="structXMessage.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);</div>
<div class="line">}</div>
<div class="ttc" id="astructXMessage_html"><div class="ttname"><a href="structXMessage.html">XMessage</a></div><div class="ttdoc">SMA-X program message.</div><div class="ttdef"><b>Definition</b> smax.h:187</div></div>
<div class="ttc" id="astructXMessage_html_a23506fc4821ab6d9671f3e6222591a96"><div class="ttname"><a href="structXMessage.html#a23506fc4821ab6d9671f3e6222591a96">XMessage::type</a></div><div class="ttdeci">char * type</div><div class="ttdoc">Message type, e.g. &quot;info&quot;, &quot;detail&quot;, &quot;warning&quot;, &quot;error&quot;.</div><div class="ttdef"><b>Definition</b> smax.h:190</div></div>
<div class="ttc" id="astructXMessage_html_a5633b1433389cec21ade3811bbe9ca5b"><div class="ttname"><a href="structXMessage.html#a5633b1433389cec21ade3811bbe9ca5b">XMessage::text</a></div><div class="ttdeci">char * text</div><div class="ttdoc">Message body (with timestamp stripped).</div><div class="ttdef"><b>Definition</b> smax.h:191</div></div>
<div class="ttc" id="astructXMessage_html_acc6113e98e7cd24d9dcfa520749a5d3f"><div class="ttname"><a href="structXMessage.html#acc6113e98e7cd24d9dcfa520749a5d3f">XMessage::prog</a></div><div class="ttdeci">char * prog</div><div class="ttdoc">Originator program name.</div><div class="ttdef"><b>Definition</b> smax.h:189</div></div>
</div><!-- fragment --><p>The processor function does not return any value, since it is called by a background thread, which does not check for return status. The <code><a class="el" href="structXMessage.html" title="SMA-X program message.">XMessage</a></code> type, a pointer to which is the sole argument of the processor, is defined in <code><a class="el" href="smax_8h.html">smax.h</a></code> as:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">  <span class="keywordtype">char</span> *host;                   <span class="comment">// Host where message originated from</span></div>
<div class="line">  <span class="keywordtype">char</span> *prog;                   <span class="comment">// Originator program name</span></div>
<div class="line">  <span class="keywordtype">char</span> *type;                   <span class="comment">// Message type, e.g. &quot;info&quot;, &quot;detail&quot;, &quot;warning&quot;, &quot;error&quot;</span></div>
<div class="line">  <span class="keywordtype">char</span> *text;                   <span class="comment">// Message body (with timestamp stripped).</span></div>
<div class="line">  <span class="keywordtype">double</span> timestamp;             <span class="comment">// Message timestamp, if available (otherwise 0.0)</span></div>
<div class="line">} <a class="code hl_struct" href="structXMessage.html">XMessage</a>;</div>
</div><!-- fragment --><p>Once you have your message consumer function, you can set it to be called for messages from select hosts, programs, and/or select message types, using <code><a class="el" href="smax-messages_8c.html#abaa2573fb8e85e8359c8853647c38f2f">smaxAddMessageProcessor()</a></code>, e.g.:</p>
<div class="fragment"><div class="line"><span class="comment">// Will call my_message_procesor for all messages coming from &quot;my_program_id&quot; from all hosts.</span></div>
<div class="line"><span class="comment">// The return ID number (if &gt; 0) can be used later to uniquely identify the processor with the set of selection </span></div>
<div class="line"><span class="comment">// parameters it is used with. So make sure to keep it handy for later.</span></div>
<div class="line"><span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code hl_function" href="smax-messages_8c.html#abaa2573fb8e85e8359c8853647c38f2f">smaxAddMessageProcessor</a>(<span class="stringliteral">&quot;*&quot;</span>, <span class="stringliteral">&quot;my_program_id&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>, my_message_processor);</div>
<div class="line"><span class="keywordflow">if</span> (<span class="keywordtype">id</span> &lt; 0) {</div>
<div class="line">  <span class="comment">// Oops that did not work as planned.</span></div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax-messages_8c_html_abaa2573fb8e85e8359c8853647c38f2f"><div class="ttname"><a href="smax-messages_8c.html#abaa2573fb8e85e8359c8853647c38f2f">smaxAddMessageProcessor</a></div><div class="ttdeci">int smaxAddMessageProcessor(const char *host, const char *prog, const char *type, void(*f)(XMessage *))</div><div class="ttdef"><b>Definition</b> smax-messages.c:291</div></div>
</div><!-- fragment --><p>Each string argument (<code>host</code>, <code>prog</code>, and <code>type</code>) may take an asterisk (<code>"*"</code>) or <code>NULL</code> as the argument to indicate that the processor function should be called for incoming messages for all values for the given parameter.</p>
<p>The processor function can also inspect what type of message it received by comparing the <code><a class="el" href="structXMessage.html" title="SMA-X program message.">XMessage</a></code> <code>type</code> value against one of the pre-defined constant expressions in <code><a class="el" href="smax_8h.html">smax.h</a></code>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><code><a class="el" href="structXMessage.html" title="SMA-X program message.">XMessage</a></code> <code>type</code>   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SMAX_MSG_STATUS</code>   </td><td class="markdownTableBodyNone">Program status update    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>SMAX_MSG_INFO</code>   </td><td class="markdownTableBodyNone">Informational program message    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SMAX_MSG_DETAIL</code>   </td><td class="markdownTableBodyNone">Program detail (i.e. verbose messages)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>SMAX_MSG_PROGRESS</code>   </td><td class="markdownTableBodyNone">Program detail (i.e. verbose messages)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SMAX_MSG_DEBUG</code>   </td><td class="markdownTableBodyNone">Program debug messages (also e.g. traces)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>SMAX_MSG_WARNING</code>   </td><td class="markdownTableBodyNone">Program warnings    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SMAX_MSG_ERROR</code>   </td><td class="markdownTableBodyNone">Program errors   </td></tr>
</table>
<p>Once you no longer need to process messages by the given processor function, you can remove it from the call list by passing its ID number (&lt;0) to <code><a class="el" href="smax-messages_8c.html#a1550f0f7aed841d5576d47ec7e62e0c4">smaxRemoveMessageProcessor()</a></code>.</p>
<hr  />
<p><a class="anchor" id="optional-metadata"></a> </p>
<h2><a class="anchor" id="autotoc_md43"></a>
Optional metadata</h2>
<h3><a class="anchor" id="autotoc_md44"></a>
Descriptions</h3>
<h3><a class="anchor" id="autotoc_md45"></a>
Coordinate Systems</h3>
<h3><a class="anchor" id="autotoc_md46"></a>
Physical units</h3>
<hr  />
<p><a class="anchor" id="error-handling"></a> </p>
<h2><a class="anchor" id="autotoc_md48"></a>
Error handling</h2>
<p>The principal error handling of the library is an extension of that of <b>xchange</b>, with further error codes defined in <code><a class="el" href="smax_8h.html">smax.h</a></code> and <code><a class="elRef" href="../../redisx/apidoc/html/redisx_8h.html">redisx.h</a></code>. The functions that return an error status (either directly, or into the integer designated by a pointer argument), can be inspected by <code><a class="el" href="smax-util_8c.html#a51856e0dc0261f8e44c8635d31d6193c">smaxErrorDescription()</a></code>, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status = <a class="code hl_function" href="smax_8c.html#aee07f085e12283ad96f42c4d77430880">smaxShare</a>(...);</div>
<div class="line"><span class="keywordflow">if</span> (status != X_SUCCESS) {</div>
<div class="line">  <span class="comment">// Ooops, something went wrong...</span></div>
<div class="line">  fprintf(stderr, <span class="stringliteral">&quot;WARNING! set value: %s&quot;</span>, <a class="code hl_function" href="smax-util_8c.html#a51856e0dc0261f8e44c8635d31d6193c">smaxErrorDescription</a>(status));</div>
<div class="line">  ...</div>
<div class="line">}</div>
<div class="ttc" id="asmax-util_8c_html_a51856e0dc0261f8e44c8635d31d6193c"><div class="ttname"><a href="smax-util_8c.html#a51856e0dc0261f8e44c8635d31d6193c">smaxErrorDescription</a></div><div class="ttdeci">const char * smaxErrorDescription(int code)</div><div class="ttdef"><b>Definition</b> smax-util.c:261</div></div>
</div><!-- fragment --><hr  />
<p><a class="anchor" id="debug-support"></a> </p>
<h2><a class="anchor" id="autotoc_md50"></a>
Debug support</h2>
<p>You can enable verbose output of the library with <code><a class="el" href="smax_8c.html#ac43709380b9ad92133a22ae0d52d107c">smaxSetVerbose(boolean)</a></code>. When enabled, it will produce status messages to <code>stderr</code>so you can follow what's going on. In addition (or alternatively), you can enable debug messages with <code><a class="elRef" href="../../xchange/apidoc/html/xchange_8h.html#a6c1304b59a5882b2286e86c6837faead">xSetDebug(boolean)</a></code>. When enabled, all errors encountered by the library (such as invalid arguments passed) will be printed to <code>stderr</code>, including call traces, so you can walk back to see where the error may have originated from. (You can also enable debug messages by default by defining the <code>DEBUG</code> constant for the compiler, e.g. by adding <code>-DDEBUG</code> to <code>CFLAGS</code> prior to calling <code>make</code>).</p>
<p>For helping to debug your application, the <b>xchange</b> library provides two macros: <code><a class="elRef" href="../../xchange/apidoc/html/xchange_8h.html#a1f038bf7ddb58819805cfc44162cb403">xvprintf()</a></code> and <code><a class="elRef" href="../../xchange/apidoc/html/xchange_8h.html#a2b0edfea798e9e08122f09dba5f189f8">xdprintf()</a></code>, for printing verbose and debug messages to <code>stderr</code>. Both work just like <code>printf()</code>, but they are conditional on verbosity being enabled via <code><a class="elRef" href="../../xchange/apidoc/html/xchange_8h.html#afbe85067ddbc92577cd00ac8f6e3026f">xSetVerbose(boolean)</a></code> and <code><a class="elRef" href="../../xchange/apidoc/html/xchange_8h.html#a6c1304b59a5882b2286e86c6837faead">xSetDebug(boolean)</a></code>, respectively. Applications using this library may use these macros to produce their own verbose and/or debugging outputs conditional on the same global settings.</p>
<hr  />
<p><a class="anchor" id="future-plans"></a> </p>
<h2><a class="anchor" id="autotoc_md52"></a>
Future plans</h2>
<p>Some obvious ways the library could evolve and grow in the not too distant future:</p>
<ul>
<li>Automated regression testing and coverage tracking.</li>
</ul>
<p>If you have an idea for a must have feature, please let me (Attila) know. Pull requests, for new features or fixes to existing ones, are especially welcome!</p>
<hr  />
<p> Copyright (C) 2024 Attila Kovcs </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
